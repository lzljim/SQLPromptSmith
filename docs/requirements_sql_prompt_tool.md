## AI SQL 提示词生成工具 — 需求分析

### 背景与目标

- **背景**: 许多开发者与数据分析师希望通过大模型完成 SQL 生成、解释、优化与调试，但大模型对具体业务数据库缺少上下文，提示词编写成本高且不稳定。
- **总体目标**: 构建一个面向 SQL 任务的提示词生成工具，能够结合用户当下的数据库环境，引导收集必要的结构化信息（库/表/列/约束/样例数据/业务语义），自动生成高质量、可复用的 AI 提示词，提升正确率与可控性。

### 术语

- **Schema/元数据**: 数据库结构信息，包含数据库、schema、表、视图、列、索引、主键、外键、检查约束、注释等。
- **方言/Dialect**: 不同数据库的 SQL 语法差异，如 MySQL、PostgreSQL、SQL Server、Oracle、SQLite、Snowflake、BigQuery、Redshift 等。
- **任务类型**: 生成 SQL、解释 SQL、优化 SQL、修复错误、迁移改写（跨方言）、数据质量检查等。

### 目标与非目标

- **目标**
  - **引导式信息收集**: 在安全前提下，自动或半自动获取最小必要的 Schema 与上下文。
  - **高质量提示词生成**: 针对任务类型与方言自动选择模板与 few-shot，控制输出格式与稳健性。
  - **上下文裁剪与相关性检索**: 对大 Schema 进行相关表/列的检索与裁剪，控制 token 预算。
  - **多形态集成**: 提供 CLI/Web UI/编辑器插件/HTTP API，满足不同使用场景。
  - **隐私与安全**: 支持脱敏/列名哈希/敏感字段屏蔽/最小权限访问。

- **非目标（本期不做）**
  - 直接执行或验证生成的 SQL（可作为可选能力/后续里程碑）。
  - 提供全面的数据治理/血缘分析能力。

### 角色画像

- **数据分析师**: 以业务问题驱动，需要快速生成或解释 SQL。
- **后端/数据工程师**: 需要高可控的 SQL 生成、优化、跨方言迁移与调试辅助。
- **DBA**: 关注权限、安全与可观测性，可提供 Schema 快照。

### 核心使用场景

1. **从业务问题到 SQL**: 用户选择数据源与相关表，输入自然语言问题，生成 SQL 的提示词。
2. **解释/审查现有 SQL**: 粘贴 SQL，结合 Schema 生成用于解释与审查的提示词。
3. **优化与调参**: 为已有 SQL 生成性能优化/索引建议的提示词。
4. **错误修复**: 根据数据库报错与 Schema 生成修复建议提示词。
5. **跨方言迁移**: 将 SQL 从方言 A 改写为 B 的提示词（包含兼容性说明与差异表）。

### 关键价值

- **更高正确率**: 通过精确上下文与模板，降低模型幻觉与方言误用。
- **更高效率**: 自动收集元数据并裁剪上下文，减少手工整理成本。
- **更强可控性**: 输出格式、风格、约束条件可配置，便于复制复用与审计。

### 产品范围

- **交互形态**: CLI、Web UI、HTTP API、VSCode/Cursor 插件。
- **数据库支持（首批）**: PostgreSQL、MySQL、SQL Server、SQLite；（后续）Oracle、Snowflake、BigQuery、Redshift。
- **提示词模板库**: 围绕任务类型与方言维护模板与 few-shot 示例。

### 功能需求

#### 引导式信息收集

- **连接与安全**
  - 仅在用户授权下建立只读连接；支持环境变量/连接字符串/本地隧道。
  - 可选择完全离线：用户上传 DDL、ER 导出或列清单 JSON。

- **元数据采集（自动/半自动）**
  - 数据库、schema、表/视图列表、列定义（类型、可空、默认值）、主键/外键/索引、检查约束、注释。
  - 选项：按前缀或正则过滤表；设定最大表数量与列数量；是否提取视图定义。
  - 选项：对选定表进行小样本行采样（例如每表 N 行、随机/分层）。

- **敏感信息与脱敏**
  - 支持基于规则（名称正则/数据分布）与手动标记敏感列。
  - 可选择对列名哈希/替换，对样本数据脱敏（掩码、泛化）。

- **业务上下文**
  - 收集业务术语表、实体关系、计量口径、常用过滤条件、时间范围默认值。
  - 支持自定义知识片段作为 RAG 检索源。

#### Schema 统一建模与相关性检索

- 将不同方言的元数据映射到统一 JSON 模型，包含实体、属性、关系、约束与注释。
- 构建轻量级 ER 图推断（基于外键/命名约定），用于相关性检索。
- 提供相似度检索：按问题关键词/列注释匹配相关表与列。

#### 提示词模板与生成引擎

- **任务类型模板**
  - 生成 SQL、解释 SQL、优化 SQL、错误修复、迁移改写、数据质量检查。
  - 每类模板含：结构化指令、方言说明、错误/约束处理、输出格式规范。

- **方言适配**
  - 针对函数、类型、时间/字符串处理、LIMIT/OFFSET、UPSERT、窗口函数等差异给出明确指示。

- **上下文裁剪与预算控制**
  - 基于相关性与 token 预算，裁剪到必要的表/列/约束与样例数据。
  - 支持“强约束最小上下文”与“丰富上下文”两种策略。

- **安全红线检查**
  - 禁止或标注潜在删除/更新高风险操作；对 DDL 操作强提示。

- **输出与版本**
  - 生成完整提示词文本与结构化 JSON（便于 API/插件复用）。
  - 保存与对比不同版本的提示词与上下文快照。

#### 交互与集成

- **CLI**: introspect、upload-ddl、select-tables、generate-prompt 子命令。
- **Web UI**: 向导式步骤（连接/采集→选择→上下文→预览→复制/导出）。
- **编辑器插件**: 读取当前文件 SQL 与连接配置，侧边栏预览提示词。
- **HTTP API**: 见下方接口草案。

#### 质量评估（可选/后续）

- 自动对生成的 SQL 在只读/沙箱环境下进行语法与基本执行计划检查。
- 采集提示词到 SQL 的成功率、一次通过率、用户修订比。

### 非功能需求

- **性能**: 在包含 1,000+ 张表的大库中，相关性检索与生成延迟 ≤ 2s（不含网络）。
- **可靠性**: 无法连接时提供离线替代方案；失败可重试并降级。
- **安全**: 最小权限访问；敏感数据默认脱敏；本地优先存储；可选不落盘。
- **可观测性**: 结构化日志、审计追踪、提示词版本化、匿名化遥测（可关闭）。

### 交互流程（Web/CLI 概要）

1. 选择数据源（或上传 DDL/JSON）→ 测试连接/校验格式。
2. 选择 Schema 与表/视图（支持搜索/过滤/批量选择）。
3. 可选：采样 N 行样本数据，标记敏感列与脱敏策略。
4. 选择任务类型与目标方言，配置输出格式与约束（如仅读、必须含注释）。
5. 输入业务问题/粘贴 SQL/粘贴报错信息。
6. 预览提示词（文本与 JSON），一键复制/导出/保存版本。

### API 设计草案

- `POST /api/introspect` — 连接数据库并返回统一 Schema JSON（或上传 DDL/JSON 解析）

```json
{
  "connection": { "dialect": "postgres", "host": "...", "database": "..." },
  "options": { "schemas": ["public"], "tableFilter": "^sales_", "maxTables": 100,
    "includeViews": true, "sampleRowsPerTable": 5, "masking": { "email": "mask" } }
}
```

- `POST /api/generate-prompt` — 基于 Schema JSON 与任务输入生成提示词

```json
{
  "taskType": "generate_sql",
  "dialect": "postgres",
  "schema": { /* 统一 Schema JSON，或引用 Introspection ID */ },
  "question": "统计上周各渠道的活跃用户数与环比",
  "constraints": { "readonly": true, "outputFormat": "sql_only", "timeWindow": "last_7d" },
  "context": { "businessGlossary": ["活跃用户: 日内至少一次登录"], "defaults": {"timezone": "Asia/Shanghai"} }
}
```

- `POST /api/upload-ddl` — 上传 DDL/CSV/JSON 解析为 Schema JSON

### 统一 Schema 数据模型（示例）

```json
{
  "dialect": "postgres",
  "entities": [
    {
      "name": "sales_order",
      "type": "table",
      "columns": [
        {"name": "id", "dataType": "bigint", "isNullable": false, "isPrimaryKey": true},
        {"name": "user_id", "dataType": "bigint", "isNullable": false},
        {"name": "amount", "dataType": "numeric(12,2)", "isNullable": false, "comment": "订单金额"},
        {"name": "created_at", "dataType": "timestamp", "default": "now()"}
      ],
      "indexes": [{"name": "idx_sales_order_user", "columns": ["user_id"]}],
      "foreignKeys": [{"columns": ["user_id"], "refTable": "users", "refColumns": ["id"]}],
      "comment": "销售订单"
    }
  ]
}
```

### 提示词模板片段（示例）

```text
你是资深数据工程师，目标方言为 {dialect}。请严格遵循以下要求：
1) 仅生成可执行 SQL，不要输出多余解释；
2) 基于提供的 Schema 与业务术语进行字段选择与关联；
3) 避免全表扫描，优先使用已存在索引；
4) 若涉及时间，默认时区 {timezone}，默认范围 {timeWindow}；
5) 不进行 DML/DDL 操作；

问题：{business_question}

相关 Schema（已裁剪）：
{schema_snippets}

若无法确定，请先给出澄清性问题列表，而非臆测。
```

### 依赖与环境

- 语言与框架：后端（Node.js/TypeScript 或 Python），前端（React/Vue）。
- 数据库驱动：pg、mysql2、mssql、sqlite3，后续扩展其它云数仓 SDK。
- 安全：.env 管理、只读账号、TLS、可选本地运行优先。

### 验收标准

- 支持 PostgreSQL 与 MySQL 的元数据采集与最小化上下文裁剪。
- 可在 Web 与 CLI 生成三类任务（生成/解释/优化）的提示词，准确套用方言模板。
- 支持离线 DDL 上传与敏感列脱敏；输出可复制与 JSON 导出。

### 里程碑

- **M1（基础版）**: CLI + Web MVP；Postgres/MySQL；生成/解释；离线 DDL；基本裁剪。
- **M2（增强版）**: 优化/修复/迁移模板；样本数据采样；版本化；编辑器插件。
- **M3（企业版）**: SSO、审计、远程连接代理、更多云数仓、质量评估与沙箱校验。

### 风险与缓解

- 大型 Schema 超出 token 预算 → 相关性检索 + 分块裁剪 + 上下文增量对话。
- 隐私合规压力 → 默认脱敏 + 本地优先 + 不落盘选项 + 可配置红线。
- 方言细微差异导致错误 → 模板持续回测 + 差异知识库 + 单元测试。

### 开放问题

- 是否支持跨库/跨数据源的联合场景？
- 是否提供可插拔的 RAG 索引与向量库抽象？
- 是否内置少量预置业务域 Glossary（如电商、SaaS）？

