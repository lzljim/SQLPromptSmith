## AI SQL 提示词生成工具 — 需求分析

### 背景与目标

- **背景**: 许多开发者与数据分析师希望通过大模型完成 SQL 生成、解释、优化与调试，但大模型对具体业务数据库缺少上下文，提示词编写成本高且不稳定。
- **总体目标**: 构建一个面向 SQL 任务的提示词生成工具，能够结合用户当下的数据库环境，引导收集必要的结构化信息（库/表/列/约束/样例数据/业务语义），自动生成高质量、可复用的 AI 提示词，提升正确率与可控性。

### 术语

- **Schema/元数据**: 数据库结构信息，包含数据库、schema、表、视图、列、索引、主键、外键、检查约束、注释等。
- **方言/Dialect**: 不同数据库的 SQL 语法差异，如 MySQL、PostgreSQL、SQL Server、Oracle、SQLite、Snowflake、BigQuery、Redshift 等。
- **任务类型**: 生成 SQL、解释 SQL、优化 SQL、修复错误、迁移改写（跨方言）、数据质量检查等。

### 范围与优先级（更新）

- **核心功能（MVP）**
  - 生成 SQL 提示词（文本 + 结构化 JSON 输出）。
  - 输入包含：任务类型、目标方言、Schema JSON 或用户粘贴的表结构片段、业务问题/现有 SQL/错误信息。
  - 默认离线使用，不要求建立数据库连接。

- **可选功能**
  - 数据库连接与元数据采集、样本数据采样与脱敏。
  - 多形态集成：CLI/Web UI/编辑器插件/HTTP API。
  - RAG/相关性检索增强、版本化与历史、质量评估与沙箱校验。

### 目标与非目标

- **目标**
  - **核心：生成 SQL 提示词（MVP）**：基于任务输入与（可选的）Schema 上下文，输出高质量可复制的提示词文本与 JSON。
  - **引导式信息收集**: 在安全前提下，自动或半自动获取最小必要的 Schema 与上下文（可选）。
  - **高质量提示词生成**: 针对任务类型与方言自动选择模板与 few-shot，控制输出格式与稳健性。
  - **上下文裁剪与相关性检索**: 对大 Schema 进行相关表/列的检索与裁剪，控制 token 预算。
  - **多形态集成**: 提供 CLI/Web UI/编辑器插件/HTTP API（可选）。
  - **隐私与安全**: 支持脱敏/列名哈希/敏感字段屏蔽/最小权限访问。

- **非目标（本期不做）**
  - 直接执行或验证生成的 SQL（可作为可选能力/后续里程碑）。
  - 提供全面的数据治理/血缘分析能力。

### 角色画像

- **数据分析师**: 以业务问题驱动，需要快速生成或解释 SQL。
- **后端/数据工程师**: 需要高可控的 SQL 生成、优化、跨方言迁移与调试辅助。
- **DBA**: 关注权限、安全与可观测性，可提供 Schema 快照。

### 核心使用场景

1. **从业务问题到 SQL**: 用户选择数据源与相关表，输入自然语言问题，生成 SQL 的提示词。
2. **解释/审查现有 SQL**: 粘贴 SQL，结合 Schema 生成用于解释与审查的提示词。
3. **优化与调参**: 为已有 SQL 生成性能优化/索引建议的提示词。
4. **错误修复**: 根据数据库报错与 Schema 生成修复建议提示词。
5. **跨方言迁移**: 将 SQL 从方言 A 改写为 B 的提示词（包含兼容性说明与差异表）。

### 关键价值

- **更高正确率**: 通过精确上下文与模板，降低模型幻觉与方言误用。
- **更高效率**: 自动收集元数据并裁剪上下文，减少手工整理成本。
- **更强可控性**: 输出格式、风格、约束条件可配置，便于复制复用与审计。

### 产品范围

- **核心输出形态**: 提示词文本与结构化 JSON。
- **交互形态（可选）**: CLI、Web UI、HTTP API、VSCode/Cursor 插件。
- **数据库支持（首批）**: PostgreSQL、MySQL、SQL Server、SQLite；（后续）Oracle、Snowflake、BigQuery、Redshift。
- **提示词模板库**: 围绕任务类型与方言维护模板与 few-shot 示例。

### 功能需求

#### 引导式信息收集（可选）

- **连接与安全（可选）**
  - 仅在用户授权下建立只读连接；支持环境变量/连接字符串/本地隧道。
  - 可选择完全离线：用户上传 DDL、ER 导出或列清单 JSON。

- **元数据采集（自动/半自动，可选）**
  - 数据库、schema、表/视图列表、列定义（类型、可空、默认值）、主键/外键/索引、检查约束、注释。
  - 选项：按前缀或正则过滤表；设定最大表数量与列数量；是否提取视图定义。
  - 选项：对选定表进行小样本行采样（例如每表 N 行、随机/分层）。

- **敏感信息与脱敏（可选）**
  - 支持基于规则（名称正则/数据分布）与手动标记敏感列。
  - 可选择对列名哈希/替换，对样本数据脱敏（掩码、泛化）。

- **业务上下文（可选）**
  - 收集业务术语表、实体关系、计量口径、常用过滤条件、时间范围默认值。
  - 支持自定义知识片段作为 RAG 检索源。

#### Schema 统一建模与相关性检索（可选）

- 将不同方言的元数据映射到统一 JSON 模型，包含实体、属性、关系、约束与注释。
- 构建轻量级 ER 图推断（基于外键/命名约定），用于相关性检索。
- 提供相似度检索：按问题关键词/列注释匹配相关表与列。

#### 提示词模板与生成引擎（核心）

- **任务类型模板（核心）**
  - 生成 SQL、解释 SQL、优化 SQL、错误修复、迁移改写、数据质量检查。
  - 每类模板含：结构化指令、方言说明、错误/约束处理、输出格式规范。

- **方言适配（核心）**
  - 针对函数、类型、时间/字符串处理、LIMIT/OFFSET、UPSERT、窗口函数等差异给出明确指示。

- **上下文裁剪与预算控制（核心）**
  - 基于相关性与 token 预算，裁剪到必要的表/列/约束与样例数据。
  - 支持“强约束最小上下文”与“丰富上下文”两种策略。

- **安全红线检查（核心）**
  - 禁止或标注潜在删除/更新高风险操作；对 DDL 操作强提示。

- **输出（核心）与版本（可选）**
  - 生成完整提示词文本与结构化 JSON（便于 API/插件复用）。
  - 保存与对比不同版本的提示词与上下文快照。

#### 交互与集成（可选）

- **CLI**: introspect、upload-ddl、select-tables、generate-prompt 子命令。
- **Web UI**: 向导式步骤（连接/采集→选择→上下文→预览→复制/导出）。
- **编辑器插件**: 读取当前文件 SQL 与连接配置，侧边栏预览提示词。
- **HTTP API**: 见下方接口草案。

#### 质量评估（可选/后续）

- 自动对生成的 SQL 在只读/沙箱环境下进行语法与基本执行计划检查。
- 采集提示词到 SQL 的成功率、一次通过率、用户修订比。

### 非功能需求

- **性能**: 在包含 1,000+ 张表的大库中，相关性检索与生成延迟 ≤ 2s（不含网络）。
- **可靠性**: 无法连接时提供离线替代方案；失败可重试并降级。
- **安全**: 最小权限访问；敏感数据默认脱敏；本地优先存储；可选不落盘。
- **可观测性**: 结构化日志、审计追踪、提示词版本化、匿名化遥测（可关闭）。

### 交互流程（Web/CLI 概要，连接为可选）

1. （可选）选择数据源或上传 DDL/JSON → 测试连接/校验格式；若无连接，支持仅上传 Schema 片段或手动粘贴表定义。
2. 选择 Schema 与表/视图（支持搜索/过滤/批量选择）。
3. 可选：采样 N 行样本数据，标记敏感列与脱敏策略。
4. 选择任务类型与目标方言，配置输出格式与约束（如仅读、必须含注释）。
5. 输入业务问题/粘贴 SQL/粘贴报错信息。
6. 预览提示词（文本与 JSON），一键复制/导出/保存版本。

### API 设计草案

- `POST /api/introspect` — 连接数据库并返回统一 Schema JSON（或上传 DDL/JSON 解析）

```json
{
  "connection": { "dialect": "postgres", "host": "...", "database": "..." },
  "options": { "schemas": ["public"], "tableFilter": "^sales_", "maxTables": 100,
    "includeViews": true, "sampleRowsPerTable": 5, "masking": { "email": "mask" } }
}
```

- `POST /api/generate-prompt` — 基于 Schema JSON 与任务输入生成提示词

```json
{
  "taskType": "generate_sql",
  "dialect": "postgres",
  "schema": { /* 统一 Schema JSON，或引用 Introspection ID */ },
  "question": "统计上周各渠道的活跃用户数与环比",
  "constraints": { "readonly": true, "outputFormat": "sql_only", "timeWindow": "last_7d" },
  "context": { "businessGlossary": ["活跃用户: 日内至少一次登录"], "defaults": {"timezone": "Asia/Shanghai"} }
}
```

- `POST /api/upload-ddl` — 上传 DDL/CSV/JSON 解析为 Schema JSON

### 统一 Schema 数据模型（示例）

```json
{
  "dialect": "postgres",
  "entities": [
    {
      "name": "sales_order",
      "type": "table",
      "columns": [
        {"name": "id", "dataType": "bigint", "isNullable": false, "isPrimaryKey": true},
        {"name": "user_id", "dataType": "bigint", "isNullable": false},
        {"name": "amount", "dataType": "numeric(12,2)", "isNullable": false, "comment": "订单金额"},
        {"name": "created_at", "dataType": "timestamp", "default": "now()"}
      ],
      "indexes": [{"name": "idx_sales_order_user", "columns": ["user_id"]}],
      "foreignKeys": [{"columns": ["user_id"], "refTable": "users", "refColumns": ["id"]}],
      "comment": "销售订单"
    }
  ]
}
```

### 提示词模板片段（示例）

```text
你是资深数据工程师，目标方言为 {dialect}。请严格遵循以下要求：
1) 仅生成可执行 SQL，不要输出多余解释；
2) 基于提供的 Schema 与业务术语进行字段选择与关联；
3) 避免全表扫描，优先使用已存在索引；
4) 若涉及时间，默认时区 {timezone}，默认范围 {timeWindow}；
5) 不进行 DML/DDL 操作；

问题：{business_question}

相关 Schema（已裁剪）：
{schema_snippets}

若无法确定，请先给出澄清性问题列表，而非臆测。
```

### 依赖与环境（连接相关依赖为可选）

- 语言与框架：后端（Node.js/TypeScript 或 Python），前端（React/Vue）。
- 数据库驱动：pg、mysql2、mssql、sqlite3，后续扩展其它云数仓 SDK。
- 安全：.env 管理、只读账号、TLS、可选本地运行优先。

### 前端（Web，Ant Design）详细需求

- **整体风格**
  - **简约大方**，以信息密度适中为原则，强调留白与层次；遵循 Ant Design 设计语言。
  - 支持浅色/深色模式切换（可选），字号与行高遵循 AntD 默认，内容区最大宽度 1200px。

- **信息架构与导航**
  - 采用 `Layout` + `Sider` 左侧导航 + `Header` 顶部工具条 + `Content` 主内容。
  - 左侧导航分组：数据源、Schema 选择、上下文/约束、任务与生成、历史与版本、设置。
  - 顶部区域提供全局搜索（表/列/模板）、帮助入口、主题/语言切换。

- **关键页面/流程（向导化）**
  1) 数据源与连接
     - 表单字段：方言、主机、端口、数据库、用户名、密码/密钥、连接字符串（互斥）、SSL 选项。
     - 操作：测试连接（`Button` + `Result`）、保存会话（仅元数据，不持久化敏感信息）。
     - 组件：`Form`、`Input`、`Select`、`Input.Password`、`Alert`、`Result`。
  2) Schema 与表选择
     - 按库/Schema/表的 3 级结构展示；支持搜索与正则过滤、批量选择、全选/反选。
     - 表清单使用 `Table`（虚拟滚动）或 `Tree` + `TreeSelect`；展示列计数、索引、备注。
     - 可选采样：每表 N 行，展示在 `Drawer`/`Modal` 中，提供脱敏预览。
  3) 上下文与约束配置
     - 业务术语表（`EditableProTable` 或 `Table` + 可编辑单元格）、默认时间范围、时区、只读约束、输出格式（sql_only/with_comment/json）。
     - 敏感列标记：`Tag` + `Checkbox`；脱敏策略选择（掩码/泛化/哈希）。
  4) 任务与生成
     - Tab 分为：生成 SQL、解释 SQL、优化 SQL、错误修复、迁移改写。
     - 输入区：`Input.TextArea`/`Monaco`（SQL 高亮）用于问题/SQL/错误粘贴；右侧为提示词预览。
     - 行为：生成提示词、复制、导出为 JSON、保存版本、对比版本（`Diff` 视图）。
  5) 历史与版本
     - 列表展示历史会话、Schema 快照与提示词版本；支持搜索、筛选、标签。
     - 详情页展示上下文、模板、生成记录，支持回滚/复用。
  6) 设置
     - 模型与 token 预算偏好（仅用于提示词长度控制，不含直连 LLM）；
     - 性能与裁剪策略（强约束/丰富上下文）、下载与隐私设置。

- **核心组件清单（AntD）**
  - 布局：`Layout`、`Sider`、`Header`、`Content`、`Breadcrumb`。
  - 表单与输入：`Form`、`Input`、`Select`、`InputNumber`、`Switch`、`Cascader`、`TreeSelect`、`Upload`。
  - 数据展示：`Table`（支持虚拟滚动）、`Descriptions`、`Collapse`、`Tabs`、`Tag`、`Badge`、`Result`、`Empty`。
  - 反馈：`Modal`、`Drawer`、`Alert`、`Spin`、`Skeleton`、`Progress`、`Notification`。
  - 其他：`Steps`（向导）、`Space`、`Divider`、`Tooltip`、`Popover`、`CopyToClipboard`（第三方）。

- **交互与可用性**
  - 表/列大量时启用虚拟化与分页；批量选择提供“只选相关表”快捷选项（基于关键词/外键推断）。
  - 提示词预览支持一键复制、JSON/文本切换、超长折叠；失败时展示结构化错误与建议。
  - 上传 DDL/JSON 支持拖拽，解析过程展示进度与日志（`Progress` + `Collapse`）。

- **状态管理与数据流**
  - 建议：React + React Router + React Query（服务端状态）+ Zustand/Recoil（本地向导状态）。
  - 统一错误边界与请求拦截；请求与响应类型以 OpenAPI/TypeScript 接口约束。

- **国际化与无障碍**
  - i18n：中文为默认，结构预留英文文案（i18next）。
  - 无障碍：为关键按钮与表格列提供 aria-label，键盘可达性，颜色对比度合规。

- **项目结构（建议）**
  - `src/pages`（分页面目录）、`src/components`（通用组件）、`src/features`（领域功能）、`src/services`（API 客户端）、`src/store`（状态）、`src/styles`（主题）。

### 后端（Node.js）详细需求

- **技术选型**
  - Node.js LTS + TypeScript；Web 框架优先 `Fastify` 或 `Express`（性能优先建议 Fastify）。
  - 校验：`zod`/`joi`；日志：`pino`；配置：`dotenv`/`env-var`；任务队列（可选）：`bullmq`。
  - 数据库驱动：`pg`、`mysql2`、`mssql`、`sqlite3`；应用自身持久层（可选）用 `SQLite`/`PostgreSQL`。

- **模块划分**
  - `introspection`：按方言实现元数据采集（表/列/约束/视图/注释/样本）。
  - `schema-model`：统一 JSON 模型映射与校验；ER 推断；相似度检索（关键词/注释）。
  - `masking`：敏感列识别与脱敏策略（掩码/泛化/哈希）。
  - `templates`：任务类型与方言模板库 + few-shot 示例管理。
  - `prompt-engine`：上下文裁剪、预算控制、输出格式化与安全红线检查。
  - `jobs`：长任务管理（采集/解析），状态与进度（queued/running/succeeded/failed）。
  - `api`：路由与控制器；`middlewares`：鉴权、限流、CORS、请求日志、错误处理中间件。

- **API 契约（扩展与细化）**
  - `POST /api/introspect`
    - 功能：建立只读连接，采集指定 schemas/表，返回 JobId 或同步结果（按数据量决定）。
    - 入参：`connection`、`options`（参考现有草案，增加 `async: boolean`, `includeComments: boolean`）。
    - 出参：`{ jobId?, schema?, warnings?, requestId }`。
  - `GET /api/jobs/:id`
    - 功能：查询长任务状态与进度，返回阶段日志与最终结果（schema JSON）。
    - 出参：`{ id, status, progress, logs: string[], result? }`。
  - `POST /api/upload-ddl`
    - 功能：上传 DDL/CSV/JSON，解析为统一 Schema；支持 zip；可选样本数据。
    - 入参：`multipart/form-data`，字段：`file`, `dialect?`, `sampling?`。
    - 出参：`{ schema, warnings?, requestId }`。
  - `POST /api/generate-prompt`
    - 功能：基于统一 Schema 与任务输入生成提示词（文本 + 结构化 JSON）。
    - 入参：`{ taskType, dialect, schema|schemaRef, question|sql|error, constraints, context }`。
    - 出参：`{ promptText, promptJson, budget: { tokens }, redFlags?: string[] }`。
  - `GET /api/dialects`
    - 功能：列出支持方言与能力矩阵（采集/模板/迁移支持）。
  - `GET /api/prompt-templates`
    - 功能：列出任务类型与方言的模板摘要；支持查询 `?taskType=&dialect=`。
  - `POST /api/schema/search`
    - 功能：在 Schema JSON 中按关键词检索相关表/列；用于前端“只选相关表”。

- **安全与合规**
  - 最小权限：仅使用只读连接；敏感字段默认脱敏；严禁持久化用户凭据。
  - CORS：允许可配置域名；速率限制（IP + 路径维度）；请求体大小上限。
  - 审计：记录请求 `requestId`、调用方、结果摘要；日志脱敏（掩盖密码/连接串）。

- **配置与运维**
  - 环境变量：`PORT`、`ALLOWED_ORIGINS`、`LOG_LEVEL`、`JOB_CONCURRENCY`、`MAX_SAMPLE_ROWS`、`DEFAULT_TOKEN_BUDGET`。
  - 观测：结构化日志 + 健康检查 `GET /healthz`；指标（可选 Prometheus 导出）。

- **错误模型**
  - 统一错误响应：`{ code, message, details?, requestId }`；分类：`VALIDATION_ERROR`、`CONNECTION_ERROR`、`TIMEOUT`、`SERVER_ERROR`。

### 前后端契约与文档

- 使用 OpenAPI 描述 API；由此生成 TypeScript 客户端类型与请求方法；在前端编译期校验。
- 提供接口示例与响应示例，覆盖错误场景与边界参数。

### 部署与交付

- 前端：Vite/CRA 构建，开启代码分割与静态资源压缩；部署至静态站点（S3/OSS + CDN）。
- 后端：容器化（Dockerfile），无状态服务；支持水平扩展与只读网络出站策略。
- 环境：开发/测试/生产隔离，开关项（样本采样、日志级别、模板实验）可配置。

### 性能预算目标（Web + API）

- 首屏加载：≤ 2s（CDN 命中，网络良好）；交互操作反馈 ≤ 200ms（本地 UI）。
- 中等规模 Schema（表 ≤ 200、列 ≤ 5000）采集 ≤ 5s；相关性检索 ≤ 200ms；提示词生成 ≤ 300ms（不含外部 LLM）。

### 验收标准补充（针对 Web + Node.js）

- 前端（AntD）
  - 提供完整向导流程 5 步；表选择性能良好（虚拟滚动/分页）。
  - 提示词预览支持文本/JSON 切换与一键复制；失败提示清晰可操作。
  - 支持 DDL/JSON 上传解析与脱敏预览；历史与版本可查看与复用。
- 后端（Node.js）
  - 实现上述 6 个 API；提供 OpenAPI 文档与健康检查；错误模型统一。
  - 支持 PostgreSQL 与 MySQL 采集；含样本行采样与可配置上限；敏感字段默认脱敏。
  - 具备基础速率限制、CORS 白名单与请求体大小限制；日志脱敏。


### 验收标准（聚焦核心）

- 能够在无数据库连接的前提下，基于用户提供的 Schema 片段/DDL/JSON 与任务输入，生成高质量 SQL 提示词（文本 + JSON）。
- 至少覆盖三类任务（生成/解释/优化）的模板与方言适配，输出可复制与 JSON 导出。
- 相关性裁剪与上下文预算控制可工作于提供的 Schema JSON 上（连接与采样能力可选）。

### 里程碑（聚焦核心）

- **M1（核心 MVP）**: 仅生成 SQL 提示词（文本+JSON），覆盖生成/解释/优化三类模板；支持离线 DDL/Schema 片段输入与基本裁剪；不要求直连数据库。
- **M2（增强）**: 可选直连与元数据采集、样本数据采样与脱敏、版本化与历史、编辑器插件。
- **M3（企业）**: SSO、审计、远程连接代理、更多云数仓、质量评估与沙箱校验。

### 风险与缓解

- 大型 Schema 超出 token 预算 → 相关性检索 + 分块裁剪 + 上下文增量对话。
- 隐私合规压力 → 默认脱敏 + 本地优先 + 不落盘选项 + 可配置红线。
- 方言细微差异导致错误 → 模板持续回测 + 差异知识库 + 单元测试。

### 开放问题

- 是否支持跨库/跨数据源的联合场景？
- 是否提供可插拔的 RAG 索引与向量库抽象？
- 是否内置少量预置业务域 Glossary（如电商、SaaS）？

